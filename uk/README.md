# 30 хвилин до Kubernetes

[Talos](https://www.talos.dev) — оптимізований для контейнерів дистрибутив Linux; переосмислення Linux для розподілених систем, таких як Kubernetes (k8s). Розроблений, щоб бути максимально мінімальним, зберігаючи при цьому практичність. З цих причин Talos має низку унікальних особливостей:

- це незмінно
- це атомарно
- це ефемерно
- це мінімально
- він безпечний за замовчуванням
- ним керують за допомогою єдиного декларативного файлу конфігурації та gRPC API

Talos можна розгорнути на контейнерних, хмарних, віртуалізованих і голих платформах.

Наведені нижче кроки та сценарій `netboot-node.sh` *n* кількість Raspberry PI з Talos (і згодом Kubernetes).

## Огляд конфігурації

![мережеве завантаження Talos](/media/netboot-talos.png)

У цьому налаштуванні ми використовуємо контрольний вузол, на якому розміщено [Dnsmasq](https://thekelleys.org.uk/dnsmasq/doc.html) , щоб забезпечити послуги TFTP, необхідні для запуску (тобто мережевого завантаження) Raspberry PI та запуску ядра Talos на PI. Звідти ядро Talos зніме все, що йому потрібно, на основі конфігураційних файлів, розміщених [Apache](https://httpd.apache.org/) . Ці конфігураційні файли створюються в сценарії `netboot-node.sh` за допомогою `talosctl` CLI і пов’язані зі згенерованим `cmdline.txt` .

Примітка щодо Dnsmasq: ми використовуємо лише частину TFTP функціональності Dnsmasq. І DNS-сервер, і функцію розподілу IP-адрес DHCP вимкнено. Не соромтеся вмикати їх, якщо потрібно. Крім того, у цій конфігурації Dnsmasq може безпечно співіснувати з вашим існуючим постачальником DHCP. **Будь ласка, переконайтеся, що IP-адреса, встановлена у верхній частині сценарію, ніколи не виділяється вашим провайдером DHCP.**

## передумови

- Принаймні два Raspberry PI 4, бажано 8 ГБ. Ви можете використовувати 4 ГБ, але настійно бажано 8 ГБ. Для HA вам знадобиться принаймні п’ять Raspberry PI (один мережевий завантажувач і чотири вузли Talos). Сценарій конфігурації налаштовується відповідно до кількості доступних вузлів.
- DHCP для розподілу IP-адреси вже має бути налаштовано в мережі.

## Встановлення

### Для кожного вузла Талос

Вам потрібно буде інсталювати Raspbian Lite на SD-карту та один раз завантажувати кожен вузол «незабаром Talos» і робити наступне (кожного разу можна використовувати ту саму картку):

Інструкція | Команда Bash
:-- | --:
Для всіх Raspberry PI має бути ввімкнено мережеве завантаження з порядком завантаження мережа &gt;&gt; SD-карта &gt;&gt; USB. | `sudo raspi-config`
Запишіть останні 8 цифр кожного серійного номера Raspberry PI. Зазвичай ви знайдете його внизу. | `cat /proc/cpuinfo`
Вимкніть усі вузли та вставте чисту SD-карту в кожен. Завершіть налаштування Netboot, використовуючи наведені вище серійні номери. |

### Вузол мережевого завантаження

Настійно рекомендується використовувати USB-накопичувач NVMe на вузлі Netboot. SD-карти мають дуже обмежений термін служби, і вузол Netboot повинен зберігати ваші конфігурації в безпеці протягом тривалого часу.

Інструкція | Команда Bash
:-- | --:
Встановіть 64-розрядну версію Raspbian Lite на USB-накопичувач. Найпростішим способом є використання [власного зображення Rasbian](https://www.raspberrypi.com/news/raspberry-pi-imager-imaging-utility/) |
[Увімкніть SSH](https://www.raspberrypi.com/documentation/computers/remote-access.html#ssh) на цьому пристрої | `sudo touch /boot/ssh`
Завантажте Pi та SSH у нього |
Встановити git | `sudo apt install git`
Клонуйте репо | `git clone https://github.com/geekdojo-ofc/rpi-talos-netboot.git`
CD до каталогу | `cd rpi-talos-netboot`
Змініть змінні вгорі відповідно до ваших потреб, зокрема додайте всі серійні номери з вузлів Talos. | `nano netboot-node.sh`
Chmod скрипт | `chmod +x netboot-node.sh`
Перейти на root | `sudo su`
Запустіть сценарій | `./netboot-node.sh`
Вийти з root | `exit`
Якщо все виглядає добре і без помилок, увімкніть Dnsmasq | `sudo systemctl enable dnsmasq.service`
Тепер запустіть вузли Talos |

Якщо припустити, що все працює правильно, ви повинні побачити, як усі вузли підключаються до мережі, відключити завантаження TFTP, перезавантажити систему, а потім розпочати налаштування Talos. Майте на увазі, що для повного завантаження, налаштування та підключення Talos може знадобитися *кілька* хвилин. Ви можете переглянути трафік TFTP на вузлі netboot за допомогою `tail -f /var/log/daemon.log` .

Конфігураційний файл Talos знаходиться в `/var/www/html/talosbaseline/talosconfig` (майбутня версія сценарію перемістить його до кращого розташування). Він знадобиться для всіх команд Talos, і ви можете почати з [перевірки налаштувань Talos, дотримуючись їхніх інструкцій](https://www.talos.dev/docs/v0.14/introduction/getting-started/#kubernetes-bootstrap) .

Удачі, і якщо у вас виникнуть проблеми зі сценарієм, ви можете [зареєструвати їх у цьому репо](https://github.com/geekdojo-ofc/rpi-talos-netboot/issues) . Подібним чином, якщо ви хочете покращити сценарій, не соромтеся надсилати запити на вилучення репозиторію.
